{% extends "base.html" %}

{% block title %}项目中心 - Fusion-AI日志记录系统{% endblock %}

{% block content %}
<!-- 创建成功引导提示（仅第一次创建时显示） -->
{% if show_first_time_tip %}
<div id="createSuccessToast" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055; margin-top: 70px;">
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="min-width: 350px;">
        <div class="toast-header" style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 255, 255, 0.9) 100%); border-bottom: 0.5px solid rgba(255, 107, 53, 0.2);">
            <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 18px;"></i>
            <strong class="me-auto" style="color: #1d1d1f; font-weight: 600;">项目创建成功！</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" style="padding: 16px; color: #1d1d1f;">
            <p class="mb-2" style="font-size: 14px; line-height: 1.6;">
                <i class="bi bi-info-circle text-primary me-2"></i>
                以后您可以在<strong>项目配置</strong>页面进行项目的新增和管理。
            </p>
            <div class="d-flex gap-2 mt-3">
                <a href="/projects" class="btn btn-sm btn-primary" style="border-radius: 8px; font-size: 13px; padding: 6px 16px;">
                    <i class="bi bi-folder"></i> 前往项目配置
                </a>
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="toast" style="border-radius: 8px; font-size: 13px; padding: 6px 16px;">
                    知道了
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="container-fluid">
    <!-- 欢迎区域 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1" style="font-weight: 600; color: #1d1d1f;">欢迎回来，{{ current_user.real_name }}</h2>
                    <p class="text-muted mb-0" style="font-size: 14px;">管理您的项目，记录工作日志
                        <br>并自动生成周报！</br></p>
                </div>
                    
            </div>
        </div>
    </div>

    <!-- 如果没有项目，显示引导界面 -->
    {% if not projects_data %}
    <div class="row">
        <div class="col-12 col-lg-8 offset-lg-2">
            <div class="card" style="border: 2px dashed rgba(255, 107, 53, 0.3); background: linear-gradient(135deg, rgba(255, 107, 53, 0.05) 0%, rgba(255, 255, 255, 0.9) 100%);">
                <div class="card-body text-center" style="padding: 60px 40px;">
                    <div style="font-size: 64px; color: #ff6b35; margin-bottom: 24px;">
                        <i class="bi bi-folder-plus"></i>
                    </div>
                    <h3 style="font-weight: 600; color: #1d1d1f; margin-bottom: 12px;">创建您的第一个项目</h3>
                    <p class="text-muted mb-4" style="font-size: 16px; line-height: 1.6;">
                        开始使用日志记录系统，创建项目后即可记录工作日志<br>
                        系统会根据您的位置自动匹配推荐项目
                    </p>
                    <a href="/projects?from=home" class="btn btn-primary btn-lg" style="border-radius: 12px; padding: 14px 32px; font-weight: 500; font-size: 16px; text-decoration: none;">
                        <i class="bi bi-plus-circle"></i> 开始您的第一个项目
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- 项目卡片网格 -->
    {% if matched_count > 0 %}
    <div class="mb-3">
        <p class="text-muted mb-0" style="font-size: 13px;">
            <i class="bi bi-geo-alt-fill text-primary"></i> 
            根据您的位置，为您推荐以下项目
        </p>
    </div>
    {% endif %}
    <div class="row g-4" id="projectsList">
        {% for item in projects_data %}
        <div class="col-12 col-md-6 col-lg-4 project-card-wrapper" data-id="{{ item.project.id }}">
            <div class="card project-card {% if item.is_matched %}matched-project{% endif %}" style="height: 100%; cursor: pointer; transition: all 0.3s ease;" onclick="window.location.href='/log/create?project_id={{ item.project.id }}'">
                <div class="card-body" style="padding: 24px;">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div style="flex: 1;">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <h5 class="mb-0" style="font-weight: 600; color: #1d1d1f; font-size: 18px;">{{ item.project.name }}</h5>
                                {% if item.is_matched %}
                                <span class="badge" style="background: rgba(255, 107, 53, 0.15); color: #ff6b35; font-weight: 500; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                    <i class="bi bi-star-fill"></i> 推荐
                                </span>
                                {% endif %}
                            </div>
                            {% if item.project.hospital_name %}
                            <p class="text-muted mb-0" style="font-size: 13px; margin-top: 4px;">
                                <i class="bi bi-hospital"></i> {{ item.project.hospital_name }}
                            </p>
                            {% endif %}
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown" onclick="event.stopPropagation();" style="padding: 4px 8px; border: none;">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/log/create?project_id={{ item.project.id }}">
                                    <i class="bi bi-plus-circle"></i> 创建日志
                                </a></li>
                                <li><a class="dropdown-item" href="/logs?project_id={{ item.project.id }}">
                                    <i class="bi bi-list-ul"></i> 查看日志
                                </a></li>
                            </ul>
                        </div>
                    </div>
                    
                    {% if item.project.region %}
                    <div class="mb-3">
                        <span class="badge" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35; font-weight: 500; padding: 4px 10px; border-radius: 6px; font-size: 12px;">
                            <i class="bi bi-geo-alt"></i> {{ item.project.region }}
                        </span>
                    </div>
                    {% endif %}
                    {% if item.project.project_scope %}
                    <div class="mb-3" style="display: flex; flex-wrap: wrap; gap: 6px;">
                        {% for scope in item.project.project_scope.split('、') %}
                            {% set scope_trimmed = scope.strip() %}
                            {% if scope_trimmed %}
                                <span class="badge" style="background: rgba(52, 152, 219, 0.1); color: #3498db; font-weight: 500; padding: 4px 10px; border-radius: 6px; font-size: 12px; white-space: nowrap;">
                                    {{ scope_trimmed }}
                                </span>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between align-items-center mt-3 pt-3" style="border-top: 0.5px solid rgba(0, 0, 0, 0.1);">
                        <div>
                            <div style="font-size: 12px; color: #6e6e73; margin-bottom: 4px;">日志数量</div>
                            <div style="font-size: 20px; font-weight: 600; color: #1d1d1f;">{{ item.log_count }}</div>
                        </div>
                        <div class="text-end">
                            <div style="font-size: 12px; color: #6e6e73; margin-bottom: 4px;">最近更新</div>
                            <div style="font-size: 14px; font-weight: 500; color: #1d1d1f;">
                                {% if item.latest_log_date %}
                                    {{ item.latest_log_date.strftime('%m-%d') }}
                                {% else %}
                                    <span class="text-muted">暂无</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<style>
.project-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15) !important;
}

.matched-project {
    border: 2px solid rgba(255, 107, 53, 0.3) !important;
}

.toast {
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    border: 0.5px solid rgba(0, 0, 0, 0.1);
}

/* 拖拽反馈样式 */
.project-card-wrapper.sortable-chosen { opacity: 0.9; }
.project-card-wrapper.sortable-ghost { opacity: 0.6; }
</style>

{% if show_first_time_tip %}
<script>
// 等待页面和Bootstrap完全加载后再显示Toast
(function() {
    function showToast() {
        console.log('[引导提示] 开始显示Toast');
        const toastElement = document.getElementById('createSuccessToast');
        console.log('[引导提示] Toast元素:', toastElement);
        
        if (!toastElement) {
            console.error('[引导提示] Toast元素未找到');
            return;
        }
        
        const toastEl = toastElement.querySelector('.toast');
        console.log('[引导提示] Toast DOM元素:', toastEl);
        
        if (!toastEl) {
            console.error('[引导提示] Toast DOM元素未找到');
            return;
        }
        
        // 检查Bootstrap是否已加载
        if (typeof bootstrap === 'undefined') {
            console.warn('[引导提示] Bootstrap未加载，使用备用方案');
            // 备用方案：直接添加show类
            toastEl.classList.add('show');
            return;
        }
        
        try {
            // 创建并显示Toast
            const toast = new bootstrap.Toast(toastEl, {
                autohide: false,  // 不自动隐藏，让用户手动关闭
                delay: 0
            });
            console.log('[引导提示] Toast实例创建成功');
            
            // 显示toast
            toast.show();
            console.log('[引导提示] Toast已显示');
            
            // 8秒后自动隐藏
            setTimeout(function() {
                toast.hide();
                console.log('[引导提示] Toast已自动隐藏');
            }, 8000);
        } catch (error) {
            console.error('[引导提示] Toast显示失败:', error);
            // 备用方案：直接添加show类
            toastEl.classList.add('show');
        }
        
        // 清除URL参数，避免刷新后再次显示
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
    
    // 等待DOM和Bootstrap加载完成
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            // 再等待一下确保Bootstrap已加载
            setTimeout(showToast, 100);
        });
    } else {
        // DOM已加载，直接执行
        setTimeout(showToast, 100);
    }
})();
</script>
{% endif %}
<!-- SortableJS，用于前端拖拽排序（本地保存顺序） -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
(function() {
    const container = document.getElementById('projectsList');
    if (!container) return;
    const STORAGE_KEY = 'order_projects_dashboard';

    function isMobileLike() {
        // 触摸/粗指针或窄屏，认为是移动端
        return (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) ||
               (typeof navigator !== 'undefined' && /Mobile|Android|iP(ad|hone)|Phone/i.test(navigator.userAgent)) ||
               (window.innerWidth && window.innerWidth < 768);
    }

    function applySavedOrder() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        try {
            const ids = JSON.parse(saved);
            const map = {};
            Array.from(container.children).forEach(el => {
                const id = el.getAttribute('data-id');
                if (id) map[id] = el;
            });
            ids.forEach(id => {
                if (map[id]) container.appendChild(map[id]);
            });
        } catch (e) {
            console.warn('[项目中心] 应用保存顺序失败', e);
        }
    }

    applySavedOrder();

    if (!isMobileLike()) {
        new Sortable(container, {
            animation: 150,
            handle: '.project-card',
            draggable: '.project-card-wrapper',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            onEnd: function() {
                const ids = Array.from(container.children).map(el => el.getAttribute('data-id')).filter(Boolean);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
                // 同步到后端（用户级记忆）
                try {
                    $.ajax({
                        url: '/api/project-order',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ order: ids.map(id => parseInt(id, 10)) })
                    });
                } catch (e) {}
            }
        });
    }
})();
</script>
{% endblock %}

